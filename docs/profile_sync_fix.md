# Саммари: Проблема с синхронизацией данных профиля

## Проблема

После покупки валюты или получения награды значения валюты и лутбоксов откатывались к старым значениям, хотя после перезагрузки игры данные были корректны. Это указывало на проблему синхронизации между серверными кешами.

## Корневая причина

Существовали **два независимых кеша профиля**:

1. **`ProfileManager.profileCache`** — обновляется при `ProfileManager.UpdateProfile`/`SaveProfile`
2. **`PlayerDataService.playerProfiles[player]`** — обновляется только при загрузке через `PlayerDataService`

Когда `ShopService.BuyLootbox` или другие операции использовали `ProfileManager.UpdateProfile`, обновлялся только кеш `ProfileManager`, а `PlayerDataService` оставался устаревшим. `ProfileSnapshotService` читал данные через `PlayerDataService.EnsureProfileLoaded`, получая старые значения.

## Применённые исправления

### 1. Централизованный сервис снапшотов (`ProfileSnapshotService`)
   - Единая точка формирования снапшотов профиля
   - Логирование всех обновлений для отладки

### 2. Исправление источника данных
   - `ProfileSnapshotService.GetSnapshot` теперь использует `ProfileManager.GetCachedProfile`/`LoadProfile` вместо `PlayerDataService`
   - `CreateLoginInfo` также берёт данные из `ProfileManager`

### 3. Исправление копирования разреженных массивов
   - `cloneArray` теперь корректно обрабатывает массивы с пропусками (важно для лутбоксов)
   - Использует `pairs` вместо `ipairs` для сохранения всех индексов

### 4. Рефакторинг обработчиков RemoteEvents
   - Все обработчики используют централизованный `SendProfileUpdate`
   - Убраны ручные сборки payload с устаревшими данными
   - Overrides содержат только специфичные поля (rewards, error), не дублируют базовые данные профиля

## Рекомендации на будущее

### 1. Единый источник правды
- ✅ **Все операции с профилем** должны идти через `ProfileManager.UpdateProfile`
- ✅ **Чтение профиля** — через `ProfileManager.GetCachedProfile` или `LoadProfile`
- ❌ **Не использовать** `PlayerDataService.GetProfile` для получения актуальных данных после операций

### 2. Централизованные снапшоты
- ✅ **Все обновления профиля** отправляются через `ProfileSnapshotService.GetSnapshot`
- ❌ **Не формировать payload вручную** — использовать централизованный сервис
- ✅ **Overrides только для специфичных полей** (rewards, error), не для базовых данных профиля

### 3. Синхронизация кешей
- Если есть несколько кешей, синхронизировать их после операций или использовать один источник
- После `ProfileManager.UpdateProfile` не полагаться на `PlayerDataService.playerProfiles`

### 4. Копирование данных
- Для разреженных массивов использовать `pairs`, не `ipairs`
- Для глубокого копирования использовать `deepCopy` с учётом структуры данных

### 5. Логирование и отладка
- Логировать все обновления профиля с контекстом
- В логах видно, какие данные отправляются клиенту
- Использовать `Logger.EnableDebug()` для детального логирования

### 6. Тестирование
- Проверять синхронизацию данных сразу после операций, без перезагрузки
- Тестировать сценарии: покупка → использование → проверка отображения
- Проверять разреженные массивы (лутбоксы с пропусками в слотах)

## Архитектурные принципы

1. **Single Source of Truth**: `ProfileManager` — единственный источник данных профиля
2. **Centralized Updates**: все обновления через `ProfileSnapshotService`
3. **Immutable Snapshots**: снапшоты создаются заново, не мутируются
4. **Explicit Overrides**: только специфичные поля в overrides, не дублирование базовых данных

Эти принципы помогают избежать проблем с синхронизацией данных в будущем.

